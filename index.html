<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è‡ªåŠ©å…¥ä½é©—è­‰</title>
</head>
<body>
  <h2>è‡ªåŠ©å…¥ä½é©—è­‰</h2>
  <label for="phone">æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</label>
  <input type="tel" id="phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼"><br><br>

  <h2>ä¸Šå‚³æ‚¨çš„è­‰ä»¶ç…§ç‰‡</h2>
  <input type="file" id="idPhoto" accept="image/*" onchange="previewIdPhoto(event)"><br><br>
  <img id="idPreview" src="" style="max-width: 320px; display: none; border: 1px solid #ccc;"><br>

  <h2>æ‹æ”ç¾å ´è‡ªæ‹ç…§</h2>
  <video id="video" width="320" height="240" autoplay playsinline muted></video><br>
  <button onclick="capturePhoto()">æ‹ç…§</button><br><br>
  <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
  <img id="snapshot" src=""><br>

  <button onclick="submitPhotos()">é–‹å§‹é©—è­‰</button>

  <p id="result"></p>
  <pre id="ocrText" style="white-space: pre-wrap; background: #f3f3f3; padding: 8px; border-radius: 4px;"></pre>
  <pre id="ocrDetails" style="white-space: pre-wrap; background: #e9ffe9; padding: 8px; border-radius: 4px; color: green;"></pre>
  <pre id="roomInfo" style="white-space: pre-wrap; background: #fff3cd; padding: 8px; border-radius: 4px; color: #856404;"></pre>

<script>
  const FACEPP_API_KEY = 'UwDnueoQfGQldxP6e_SJQpZUJtFAs9YA';
  const FACEPP_API_SECRET = 'ks9e_h3BkVfQ52pvc-FyWgdzcHUvmY0S';
  const FACEPP_ENDPOINT = 'https://api-us.faceplusplus.com/facepp/v3/compare';
  const OCR_SPACE_ENDPOINT = 'https://api.ocr.space/parse/image';
  const OCR_SPACE_API_KEY = 'helloworld';
  const ID_WRITE_URL = 'https://script.google.com/macros/s/AKfycbzjPK4G4Kgj0X5lLRDeY2EixBAOFuw58uhMTc6G8WAZyHwOmXKUUo_qnpzBjPFLw-tu/exec';
  const RESERVATION_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxcloKN6uq7sJ9-IrfMlecLdzDqrLSW-GXhVYl_m24i9nNv0t_oYsmwddelmsyLx8XkTg/exec';

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const snapshot = document.getElementById('snapshot');
  const result = document.getElementById('result');
  const ocrText = document.getElementById('ocrText');
  const ocrDetails = document.getElementById('ocrDetails');
  const idPreview = document.getElementById('idPreview');
  const roomInfo = document.getElementById('roomInfo');

  let ocrName = null; // å…¨åŸŸè®Šæ•¸å„²å­˜ OCR æ“·å–çš„å§“å

  function previewIdPhoto(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        idPreview.src = e.target.result;
        idPreview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  }

  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    } catch (error) {
      alert("ç„¡æ³•å•Ÿç”¨æ”åƒé ­ï¼š" + error.message);
    }
  }

  initCamera();
  function capturePhoto() {
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataURL = canvas.toDataURL('image/jpeg', 0.9);
    snapshot.src = dataURL;
    snapshot.style.display = 'block';
    canvas.style.display = 'block';
  }

  function resizeImage(file, maxSize = 1000) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = (e) => { img.src = e.target.result; };
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => {
          const file = new File([blob], 'resized.jpg', { type: 'image/jpeg' });
          resolve(file);
        }, 'image/jpeg', 0.8);
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function checkIfValidDocument(imageBlob) {
    const ocrFormData = new FormData();
    ocrFormData.append('apikey', OCR_SPACE_API_KEY);
    ocrFormData.append('language', 'eng');
    ocrFormData.append('isOverlayRequired', false);
    ocrFormData.append('file', imageBlob);

    const response = await fetch(OCR_SPACE_ENDPOINT, { method: 'POST', body: ocrFormData });
    const data = await response.json();
    const parsedText = (data?.ParsedResults?.[0]?.ParsedText || '').toUpperCase();
    ocrText.innerText = "ğŸ“„ OCR è¾¨è­˜æ–‡å­—ï¼š\n" + parsedText;

    // æ“·å–å§“å
    const nameMatch = parsedText.match(/å§“å[:ï¼š]?\s*([\u4e00-\u9fa5]{2,4})/);
    ocrName = nameMatch ? nameMatch[1] : null;

    const taiwanIdRegex = /[A-Z][12]\d{8}/;
    const fuzzyIdRegex = /[A-Z][0-9A-Z]{9}/;
    const mrzRegex = /P<|[A-Z]{3}[0-9<]{10,}/;
    const keywords = ["REPUBLIC", "IDENTITY", "PASSPORT", "ROC", "TAIWAN", "MINISTRY", "ID", "NATIONAL", "CHINA"];

    const hasTaiwanId = taiwanIdRegex.test(parsedText);
    const fuzzyMatch = !hasTaiwanId && parsedText.match(fuzzyIdRegex);
    const hasMrz = mrzRegex.test(parsedText);
    const keywordMatched = keywords.some(word => parsedText.includes(word));
    const fallback = parsedText.length >= 30 && /\d{2,}/.test(parsedText);
    const idMatch = parsedText.match(taiwanIdRegex);

    let debug = '';
    
    // æ“·å–å§“å
    const nameMatch = parsedText.match(/(?:å§“å|NAME)[:ï¼š]?\s*([A-Z\u4e00-\u9fa5]{2,10})/);
    ocrName = nameMatch ? nameMatch[1] : null;
    debug += ocrName ? `âœ… æ“·å–åˆ°å§“åï¼š${ocrName}\n` : 'âŒ ç„¡æ³•æ“·å–å§“å\n`;
    
    debug += hasTaiwanId ? `âœ… åµæ¸¬åˆ°èº«åˆ†è­‰è™Ÿï¼š${idMatch[0]}\n` : 'âŒ èº«åˆ†è­‰è™Ÿæœªå‘½ä¸­\n';
    if (!hasTaiwanId && fuzzyMatch) debug += `âš ï¸ æ¨¡ç³Šå‘½ä¸­ï¼ˆå¯èƒ½èª¤è¾¨ï¼‰ï¼š${fuzzyMatch[0]}\n`;
    debug += hasMrz ? 'âœ… MRZ æ ¼å¼å‘½ä¸­\n' : 'âŒ MRZ æ ¼å¼æœªå‘½ä¸­\n';
    debug += keywordMatched ? 'âœ… é—œéµå­—å‘½ä¸­\n' : 'âŒ é—œéµå­—æœªå‘½ä¸­\n';
    debug += fallback ? 'âœ… fallback æ¢ä»¶æˆç«‹\n' : 'âŒ fallback æ¢ä»¶æœªæˆç«‹\n';
    
    const finalResult = hasTaiwanId || hasMrz || keywordMatched || fallback || !!fuzzyMatch;
    debug += finalResult ? 'â†’ âœ… åˆ¤å®šç‚ºæ­£å¼è­‰ä»¶' : 'â†’ âŒ åˆ¤å®šç‚ºéæ­£å¼è­‰ä»¶';
    
    ocrDetails.innerText = debug;
    return hasTaiwanId ? idMatch[0] : null;
  }

  async function getReservationByNameAndPhone(name, phone) {
    try {
      const res = await fetch(RESERVATION_SHEET_URL);
      const data = await res.json();
      const normalized = phone.startsWith('0') ? phone : '0' + phone;
      const match = data.find(entry =>
        entry['å§“å'] === name && (entry['é›»è©±'] === normalized || entry['é›»è©±'] === "'" + normalized)
      );
      return match || null;
    } catch (err) {
      console.error("âŒ æŸ¥è©¢é ç´„åå–®å¤±æ•—:", err);
      return null;
    }
  }

  async function submitPhotos() {
    const idFile = document.getElementById('idPhoto').files[0];
    const phone = document.getElementById('phone').value.trim();
    if (!idFile || !phone) {
      alert("è«‹ä¸Šå‚³è­‰ä»¶ä¸¦å¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼");
      return;
    }

    result.innerText = "â³ OCR èˆ‡å§“åæ“·å–ä¸­...";
    ocrText.innerText = '';
    ocrDetails.innerText = '';
    roomInfo.innerText = '';

    const selfieDataUrl = canvas.toDataURL('image/jpeg', 0.9);
    const selfieBlob = await (await fetch(selfieDataUrl)).blob();
    const resizedIdBlob = await resizeImage(idFile);

    if (resizedIdBlob.size > 1024000) {
      result.innerText = "âŒ éŒ¯èª¤ï¼šå£“ç¸®å¾Œåœ–æª”ä»è¶…é 1MBï¼Œè«‹æ›å¼µç…§ç‰‡ã€‚";
      return;
    }

    const idNumber = await checkIfValidDocument(resizedIdBlob);
    if (!idNumber) {
      result.innerText = "âŒ ç„¡æ³•è¾¨è­˜æœ‰æ•ˆèº«åˆ†è­‰è™Ÿï¼Œè«‹é‡æ–°æ‹æ”ã€‚";
      return;
    }

    if (!ocrName) {
      result.innerText = "âŒ ç„¡æ³•æ“·å–è­‰ä»¶ä¸Šå§“åï¼Œè«‹ç¢ºèªç…§ç‰‡æ¸…æ™°ã€‚";
      return;
    }

    const reservation = await getReservationByNameAndPhone(ocrName, phone);
    if (!reservation) {
      result.innerText = `âŒ æŸ¥ç„¡æ­¤å§“åï¼ˆ${ocrName}ï¼‰èˆ‡æ‰‹æ©Ÿè™Ÿç¢¼çµ„åˆçš„é ç´„ç´€éŒ„ã€‚`;
      return;
    }

    result.innerText = "â³ åŸ·è¡Œè‡‰éƒ¨æ¯”å°ä¸­...";

    const formData = new FormData();
    formData.append('api_key', FACEPP_API_KEY);
    formData.append('api_secret', FACEPP_API_SECRET);
    formData.append('image_file1', resizedIdBlob);
    formData.append('image_file2', selfieBlob);

    try {
      const res = await fetch(FACEPP_ENDPOINT, { method: 'POST', body: formData });
      const json = await res.json();
      const similarity = json.confidence;

      if (similarity && similarity > 60) {
        result.innerText = `âœ… é©—è­‰æˆåŠŸï¼Œç›¸ä¼¼åº¦ ${similarity}`;

        const today = new Date().toISOString().split('T')[0];
        const usedRooms = JSON.parse(localStorage.getItem('usedRooms_' + today) || '[]');
        const room = [...Array(12).keys()].map(n => n + 1).find(r => !usedRooms.includes(r));
        if (!room) {
          roomInfo.innerText = 'âŒ ä»Šæ—¥æˆ¿é–“å·²æ»¿';
          return;
        }
        usedRooms.push(room);
        localStorage.setItem('usedRooms_' + today, JSON.stringify(usedRooms));
        roomInfo.innerText = `æˆ¿è™Ÿï¼š${room}\nå…¥å ´å¯†ç¢¼ï¼š8899`;

        const payload = new URLSearchParams();
        payload.append('data', [
          reservation['å•†å“åç¨±'] || '',
          reservation['å§“å'] || '',
          reservation['é›»è©±'] || '',
          reservation['Email'] || '',
          reservation['é–‹å§‹æ™‚é–“'] || '',
          reservation['çµæŸæ™‚é–“'] || '',
          idNumber
        ].join(','));

        const writeRes = await fetch(ID_WRITE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: payload
        });

        const writeText = await writeRes.text();
        if (writeText.includes('Success')) {
          roomInfo.innerText += `\nâœ… èº«åˆ†è­‰è™Ÿå·²å¯«å…¥`;
        } else {
          roomInfo.innerText += `\nâŒ å¯«å…¥å¤±æ•—ï¼š${writeText}`;
        }

      } else {
        result.innerText = `âŒ é©—è­‰å¤±æ•—ï¼Œç›¸ä¼¼åº¦ ${similarity}`;
      }
    } catch (e) {
      console.error("æäº¤éŒ¯èª¤ï¼š", e);
      result.innerText = "âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message;
    }
  }
</script>
</body>
</html>
