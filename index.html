<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è‡ªåŠ©å…¥ä½é©—è­‰</title>
  <style>
    .step { display: none; }
    .step.active { display: block; }
    video, canvas, img { width: 320px; display: block; margin: 10px auto; }
    pre { white-space: pre-wrap; background: #f3f3f3; padding: 8px; border-radius: 4px; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>è‡ªåŠ©å…¥ä½é©—è­‰æµç¨‹</h2>

  <div id="step1" class="step active">
    <label for="phone">æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</label>
    <input type="tel" id="phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼"><br><br>
    <button onclick="nextStep(2)">ä¸‹ä¸€æ­¥</button>
  </div>

  <div id="step2" class="step">
    <h2>æ‹æ”èº«åˆ†è­‰</h2>
    <video id="idVideo" autoplay playsinline muted></video><br>
    <button onclick="captureIdPhoto()">æ‹ç…§</button><br><br>
    <canvas id="idCanvas" width="640" height="480" style="display:none;"></canvas>
    <img id="idPreview" src="" style="display:none; border:1px solid #ccc;"><br>
    <button onclick="prevStep(1)">ä¸Šä¸€æ­¥</button>
    <button onclick="nextStep(3)">ä¸‹ä¸€æ­¥</button>
  </div>

  <div id="step3" class="step">
    <h2>æ‹æ”ç¾å ´è‡ªæ‹ç…§</h2>
    <video id="video" autoplay playsinline muted></video><br>
    <button onclick="capturePhoto()">æ‹ç…§</button><br><br>
    <canvas id="canvas" width="640" height="480" style="display:none;"></canvas>
    <img id="snapshot" src=""><br>
    <button onclick="prevStep(2)">ä¸Šä¸€æ­¥</button>
    <button onclick="nextStep(4)">ä¸‹ä¸€æ­¥</button>
  </div>

  <div id="step4" class="step">
    <button onclick="prevStep(3)">ä¸Šä¸€æ­¥</button>
    <button onclick="submitPhotos()">é–‹å§‹é©—è­‰</button>
    <p id="result"></p>
    <pre id="ocrText"></pre>
    <pre id="ocrDetails" style="color: green;"></pre>
    <pre id="roomInfo" style="color: #856404;"></pre>
  </div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const snapshot = document.getElementById('snapshot');
const result = document.getElementById('result');
const ocrText = document.getElementById('ocrText');
const ocrDetails = document.getElementById('ocrDetails');
const idPreview = document.getElementById('idPreview');

const OCR_SPACE_API_KEY = 'helloworld';
const OCR_SPACE_ENDPOINT = 'https://api.ocr.space/parse/image';
const FACEPP_API_KEY = 'UwDnueoQfGQldxP6e_SJQpZUJtFAs9YA';
const FACEPP_API_SECRET = 'ks9e_h3BkVfQ52pvc-FyWgdzcHUvmY0S';
const FACEPP_ENDPOINT = 'https://api-us.faceplusplus.com/facepp/v3/compare';
const ID_WRITE_URL = 'https://script.google.com/macros/s/AKfycbzjPK4G4Kgj0X5lLRDeY2EixBAOFuw58uhMTc6G8WAZyHwOmXKUUo_qnpzBjPFLw-tu/exec';
const RESERVATION_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxcloKN6uq7sJ9-IrfMlecLdzDqrLSW-GXhVYl_m24i9nNv0t_oYsmwddelmsyLx8XkTg/exec';

function nextStep(n) {
  for (let i = 1; i <= 4; i++) document.getElementById('step' + i).classList.remove('active');
  document.getElementById('step' + n).classList.add('active');
  if (n === 2) {
    initMainCamera('idVideo');
  } else if (n === 3) {
    stopStream(idStream, 'idVideo');
    initFrontCamera('video');
  }
}
function prevStep(n) { nextStep(n); }

let idStream = null;
let selfieStream = null;

function stopStream(stream, videoId) {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    document.getElementById(videoId).srcObject = null;
  }
}

async function initMainCamera(videoId) {
  try {
    if (idStream) {
      idStream.getTracks().forEach(track => track.stop());
      document.getElementById(videoId).srcObject = null;
    }
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    document.getElementById(videoId).srcObject = stream;
    idStream = stream;
  } catch (err) {
    alert("âŒ ç„¡æ³•å•Ÿç”¨ä¸»é¡é ­ï¼š" + err.message);
    console.error(err);
  }
}

async function initFrontCamera(videoId) {
  try {
    if (selfieStream) {
      selfieStream.getTracks().forEach(track => track.stop());
      document.getElementById(videoId).srcObject = null;
    }
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
    document.getElementById(videoId).srcObject = stream;
    selfieStream = stream;
  } catch (err) {
    alert("âŒ ç„¡æ³•å•Ÿç”¨å‰é¡é ­ï¼š" + err.message);
    console.error(err);
  }
}

function captureIdPhoto() {
  const video = document.getElementById('idVideo');
  const canvas = document.getElementById('idCanvas');
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataURL = canvas.toDataURL('image/jpeg', 0.9);
  document.getElementById('idPreview').src = dataURL;
  document.getElementById('idPreview').style.display = 'block';
}

function capturePhoto() {
  const ctx = document.getElementById('canvas').getContext('2d');
  ctx.drawImage(document.getElementById('video'), 0, 0, 320, 240);
  const dataURL = document.getElementById('canvas').toDataURL('image/jpeg', 0.9);
  document.getElementById('snapshot').src = dataURL;
}

function resizeImage(file, maxSize = 1000) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = (e) => { img.src = e.target.result; };
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => {
        const file = new File([blob], 'resized.jpg', { type: 'image/jpeg' });
        resolve(file);
      }, 'image/jpeg', 0.8);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function checkIfValidDocument(imageBlob) {
  const ocrFormData = new FormData();
  ocrFormData.append('apikey', OCR_SPACE_API_KEY);
  ocrFormData.append('language', 'eng');
  ocrFormData.append('isOverlayRequired', false);
  ocrFormData.append('file', imageBlob);

  const response = await fetch(OCR_SPACE_ENDPOINT, { method: 'POST', body: ocrFormData });
  const data = await response.json();
  const parsedTextRaw = data?.ParsedResults?.[0]?.ParsedText?.trim() || '';
  const parsedText = parsedTextRaw.toUpperCase();
  ocrText.innerText = "ğŸ“„ OCR è¾¨è­˜æ–‡å­—ï¼š\n" + parsedText;

  const taiwanIdRegex = /[A-Z][12]\d{8}/;
  const fuzzyIdRegex = /[A-Z][0-9A-Z]{9}/;
  const mrzRegex = /P<|[A-Z]{3}[0-9<]{10,}/;
  const keywords = ["REPUBLIC", "IDENTITY", "PASSPORT", "ROC", "TAIWAN", "MINISTRY", "ID", "NATIONAL", "CHINA"];

  const hasTaiwanId = taiwanIdRegex.test(parsedText);
  const fuzzyMatch = !hasTaiwanId && parsedText.match(fuzzyIdRegex);
  const hasMrz = mrzRegex.test(parsedText);
  const keywordMatched = keywords.some(word => parsedText.includes(word));
  const fallback = parsedText.length >= 30 && /\d{2,}/.test(parsedText);
  const idMatch = parsedText.match(taiwanIdRegex);

  let debug = '';
  debug += hasTaiwanId ? `âœ… åµæ¸¬åˆ°èº«åˆ†è­‰è™Ÿï¼š${idMatch[0]}\n` : 'âŒ èº«åˆ†è­‰è™Ÿæœªå‘½ä¸­\n';
  if (!hasTaiwanId && fuzzyMatch) debug += `âš ï¸ æ¨¡ç³Šå‘½ä¸­ï¼ˆå¯èƒ½èª¤è¾¨ï¼‰ï¼š${fuzzyMatch[0]}\n`;
  debug += hasMrz ? 'âœ… MRZ æ ¼å¼å‘½ä¸­\n' : 'âŒ MRZ æ ¼å¼æœªå‘½ä¸­\n';
  debug += keywordMatched ? 'âœ… é—œéµå­—å‘½ä¸­\n' : 'âŒ é—œéµå­—æœªå‘½ä¸­\n';
  debug += fallback ? 'âœ… fallback æ¢ä»¶æˆç«‹\n' : 'âŒ fallback æ¢ä»¶æœªæˆç«‹\n';
  const finalResult = hasTaiwanId || hasMrz || keywordMatched || fallback || !!fuzzyMatch;
  debug += finalResult ? 'â†’ âœ… åˆ¤å®šç‚ºæ­£å¼è­‰ä»¶' : 'â†’ âŒ åˆ¤å®šç‚ºéæ­£å¼è­‰ä»¶';
  ocrDetails.innerText = debug;
  return finalResult;
}

async function getReservationByPhone(phone) {
  try {
    const res = await fetch(RESERVATION_SHEET_URL);
    const data = await res.json();
    const normalized = phone.startsWith('0') ? phone : '0' + phone;
    return data.find(e => e['é›»è©±'] === normalized || e['é›»è©±'] === "'" + normalized) || null;
  } catch (err) {
    console.error("âŒ æŸ¥è©¢å¤±æ•—", err);
    return null;
  }
}

async function submitPhotos() {
  const idCanvas = document.getElementById('idCanvas');
  const idDataUrl = idCanvas.toDataURL('image/jpeg', 0.9);
  const idBlob = await (await fetch(idDataUrl)).blob();
  const selfieDataUrl = document.getElementById('canvas').toDataURL('image/jpeg', 0.9);
  const selfieBlob = await (await fetch(selfieDataUrl)).blob();

  const phone = document.getElementById('phone').value.trim();
  if (!idBlob || !selfieBlob || !phone) {
    alert("è«‹å…ˆå®Œæˆæ‰€æœ‰æ‹ç…§èˆ‡è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼");
    return;
  }

  const reservation = await getReservationByPhone(phone);
  if (!reservation) {
    document.getElementById('result').innerText = "âŒ æŸ¥ç„¡é ç´„";
    return;
  }

  result.innerText = "â³ é©—è­‰ä¸­ï¼Œè«‹ç¨å€™...";
  ocrText.innerText = '';
  ocrDetails.innerText = '';

  const resizedIdBlob = await resizeImage(idBlob);
  if (resizedIdBlob.size > 1024000) {
    result.innerText = "âŒ éŒ¯èª¤ï¼šå£“ç¸®å¾Œåœ–æª”ä»è¶…é 1MBï¼Œè«‹æ›å¼µç…§ç‰‡ã€‚";
    return;
  }

  const isValidDoc = await checkIfValidDocument(resizedIdBlob);
  if (!isValidDoc) {
    result.innerText = "âŒ æ­¤ç…§ç‰‡ç„¡æ³•è­˜åˆ¥ç‚ºæ­£å¼è­‰ä»¶ï¼Œè«‹é‡æ–°æ‹æ”ã€‚";
    return;
  }

  const formData = new FormData();
  formData.append('api_key', FACEPP_API_KEY);
  formData.append('api_secret', FACEPP_API_SECRET);
  formData.append('image_file1', resizedIdBlob, 'id.jpg');
  formData.append('image_file2', selfieBlob, 'selfie.jpg');

  try {
    const res = await fetch(FACEPP_ENDPOINT, { method: 'POST', body: formData });
    const json = await res.json();
    if (json.confidence !== undefined) {
      const similarity = json.confidence;
      result.innerText = similarity > 60 ? `âœ… é©—è­‰æˆåŠŸï¼Œç›¸ä¼¼åº¦ ${similarity}` : `âŒ é©—è­‰å¤±æ•—ï¼Œç›¸ä¼¼åº¦ ${similarity}`;
    } else {
      result.innerText = "âŒ éŒ¯èª¤ï¼š" + (json.error_message || "ç„¡æ³•æ¯”å°");
    }
  } catch (e) {
    console.error("æäº¤éŒ¯èª¤ï¼š", e);
    result.innerText = "âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š" + e.message;
  }
}
</script>
</body>
</html>
