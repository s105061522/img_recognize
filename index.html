
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>自助入住驗證</title>
  <style>
    .step { display: none; }
    .step.active { display: block; }
    video, canvas, img { width: 320px; display: block; margin: 10px auto; }
    pre { white-space: pre-wrap; background: #f3f3f3; padding: 8px; border-radius: 4px; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>自助入住驗證流程</h2>

  <div id="step1" class="step active">
    <label for="phone">手機號碼：</label>
    <input type="tel" id="phone" placeholder="請輸入手機號碼"><br><br>
    <p id="error1" class="error"></p>
    <button onclick="nextStep(2)">下一步</button>
  </div>

  <div id="step2" class="step">
    <h2>上傳您的證件照片</h2>
    <input type="file" id="idPhoto" accept="image/*" onchange="previewIdPhoto(event)"><br><br>
    <img id="idPreview" src="" style="max-width: 320px; display: none; border: 1px solid #ccc;"><br>
    <p id="error2" class="error"></p>
    <button onclick="prevStep(1)">上一步</button>
    <button onclick="nextStep(3)">下一步</button>
  </div>

  <div id="step3" class="step">
    <h2>拍攝現場自拍照</h2>
    <video id="video" width="320" height="240" autoplay playsinline muted></video><br>
    <button onclick="capturePhoto()">拍照</button><br><br>
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
    <img id="snapshot" src=""><br>
    <p id="error3" class="error"></p>
    <button onclick="prevStep(2)">上一步</button>
    <button onclick="nextStep(4)">下一步</button>
  </div>

  <div id="step4" class="step">
    <button onclick="submitPhotos()">開始驗證</button>
    <p id="result"></p>
    <pre id="ocrText"></pre>
    <pre id="ocrDetails" style="color: green;"></pre>
    <pre id="roomInfo" style="color: #856404;"></pre>
    <button onclick="prevStep(3)">上一步</button>
  </div>

<script>
  const FACEPP_API_KEY = 'UwDnueoQfGQldxP6e_SJQpZUJtFAs9YA';
  const FACEPP_API_SECRET = 'ks9e_h3BkVfQ52pvc-FyWgdzcHUvmY0S';
  const FACEPP_ENDPOINT = 'https://api-us.faceplusplus.com/facepp/v3/compare';
  const OCR_SPACE_ENDPOINT = 'https://api.ocr.space/parse/image';
  const OCR_SPACE_API_KEY = 'helloworld';
  const ID_WRITE_URL = 'https://script.google.com/macros/s/AKfycbzjPK4G4Kgj0X5lLRDeY2EixBAOFuw58uhMTc6G8WAZyHwOmXKUUo_qnpzBjPFLw-tu/exec';
  const RESERVATION_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxcloKN6uq7sJ9-IrfMlecLdzDqrLSW-GXhVYl_m24i9nNv0t_oYsmwddelmsyLx8XkTg/exec';

  let currentStep = 1;
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const snapshot = document.getElementById('snapshot');
  const result = document.getElementById('result');
  const ocrText = document.getElementById('ocrText');
  const ocrDetails = document.getElementById('ocrDetails');
  const idPreview = document.getElementById('idPreview');
  const roomInfo = document.getElementById('roomInfo');

  function showStep(step) {
    for (let i = 1; i <= 4; i++) {
      document.getElementById('step' + i).classList.remove('active');
    }
    document.getElementById('step' + step).classList.add('active');
    currentStep = step;
    if (step === 3) initCamera();
  }

  function nextStep(step) {
    if (step === 2 && !document.getElementById('phone').value.trim()) {
      document.getElementById('error1').innerText = '請輸入手機號碼'; return;
    } else if (step === 3 && !document.getElementById('idPhoto').files[0]) {
      document.getElementById('error2').innerText = '請上傳證件照片'; return;
    } else if (step === 4 && !document.getElementById('snapshot').src) {
      document.getElementById('error3').innerText = '請拍攝自拍照片'; return;
    }
    ['error1', 'error2', 'error3'].forEach(id => document.getElementById(id).innerText = '');
    showStep(step);
  }

  function prevStep(step) {
    showStep(step);
  }

  function previewIdPhoto(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function (e) {
        idPreview.src = e.target.result;
        idPreview.style.display = 'block';
        nextStep(3);
      };
      reader.readAsDataURL(file);
    }
  }

  function capturePhoto() {
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const dataURL = canvas.toDataURL('image/png');
    snapshot.src = dataURL;
    canvas.style.display = 'block';
    nextStep(4);
  }

  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
      video.srcObject = stream;
    } catch (err) {
      alert("無法啟用相機：" + err.message);
    }
  }

  async function submitPhotos() {
    const idFile = document.getElementById('idPhoto').files[0];
    const phone = document.getElementById('phone').value.trim();
    if (!idFile || !phone) { alert("請上傳證件並填寫手機號碼"); return; }

    const resv = await fetch(RESERVATION_SHEET_URL).then(r => r.json());
    const match = resv.find(r => r['電話'] === phone || r['電話'] === '0' + phone || r['電話'] === "'" + phone);
    if (!match) { result.innerText = "❌ 查無預約"; return; }

    result.innerText = "⏳ 驗證中..."; ocrText.innerText = ''; ocrDetails.innerText = ''; roomInfo.innerText = '';
    const resizedIdBlob = await resizeImage(idFile);
    if (resizedIdBlob.size > 1024000) return result.innerText = "❌ 圖片過大";
    const selfieBlob = await (await fetch(snapshot.src)).blob();
    const idNumber = await checkIfValidDocument(resizedIdBlob);
    if (!idNumber) return result.innerText = "❌ 證件不合法";

    const formData = new FormData();
    formData.append('api_key', FACEPP_API_KEY);
    formData.append('api_secret', FACEPP_API_SECRET);
    formData.append('image_file1', resizedIdBlob);
    formData.append('image_file2', selfieBlob);
    const faceRes = await fetch(FACEPP_ENDPOINT, { method: 'POST', body: formData });
    const sim = (await faceRes.json()).confidence;
    if (!sim || sim < 60) return result.innerText = `❌ 驗證失敗，相似度 ${sim}`;

    result.innerText = `✅ 驗證成功，相似度 ${sim}`;
    const today = new Date().toISOString().split('T')[0];
    const usedRooms = JSON.parse(localStorage.getItem('usedRooms_' + today) || '[]');
    const room = [...Array(12).keys()].map(n => n + 1).find(r => !usedRooms.includes(r));
    if (!room) return roomInfo.innerText = '❌ 今日房間已滿';
    usedRooms.push(room);
    localStorage.setItem('usedRooms_' + today, JSON.stringify(usedRooms));
    roomInfo.innerText = `房號：${room}\n入場密碼：8899`;

    const payload = new URLSearchParams();
    payload.append('data', [match['商品名稱'], match['姓名'], match['電話'], match['Email'], match['開始時間'], match['結束時間'], idNumber].join(','));
    const writeRes = await fetch(ID_WRITE_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: payload });
    roomInfo.innerText += (await writeRes.text()).includes('Success') ? '\n✅ 寫入成功' : '\n❌ 寫入失敗';
  }

  async function checkIfValidDocument(blob) {
    const fd = new FormData();
    fd.append('apikey', OCR_SPACE_API_KEY);
    fd.append('language', 'eng');
    fd.append('isOverlayRequired', false);
    fd.append('file', blob);
    const data = await fetch(OCR_SPACE_ENDPOINT, { method: 'POST', body: fd }).then(r => r.json());
    const text = (data?.ParsedResults?.[0]?.ParsedText || '').toUpperCase();
    ocrText.innerText = "📄 OCR 辨識文字：\n" + text;
    const id = /[A-Z][12]\d{8}/.exec(text);
    let d = id ? `✅ 偵測身分證：${id[0]}\n` : '❌ 無身分證\n';
    d += /P<|[A-Z]{3}[0-9<]{10,}/.test(text) ? '✅ MRZ 命中\n' : '❌ MRZ 未命中\n';
    d += /(REPUBLIC|TAIWAN|ID|NATIONAL|ROC)/.test(text) ? '✅ 關鍵字命中\n' : '❌ 關鍵字未命中\n';
    ocrDetails.innerText = d;
    return id ? id[0] : null;
  }

  function resizeImage(file, max = 1000) {
    return new Promise((res, rej) => {
      const img = new Image();
      const reader = new FileReader();
      reader.onload = e => img.src = e.target.result;
      img.onload = () => {
        const scale = Math.min(1, max / Math.max(img.width, img.height));
        const canvas = document.createElement('canvas');
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(blob => res(new File([blob], 'resized.jpg', { type: 'image/jpeg' })), 'image/jpeg', 0.8);
      };
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
  }
</script>
</body>
</html>
