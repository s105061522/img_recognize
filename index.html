<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>自助入住驗證</title>
  <style>
    .step { display: none; }
    .step.active { display: block; }
    video, canvas, img { width: 320px; display: block; margin: 10px auto; }
    pre { white-space: pre-wrap; background: #f3f3f3; padding: 8px; border-radius: 4px; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>自助入住驗證流程</h2>

  <div id="step1" class="step active">
    <label for="phone">手機號碼：</label>
    <input type="tel" id="phone" placeholder="請輸入手機號碼"><br><br>
    <button onclick="nextStep(2)">下一步</button>
  </div>

  <div id="step2" class="step">
    <h2>拍攝身分證</h2>
    <video id="externalVideo" autoplay playsinline></video><br>
    <select id="cameraSelect" style="display:block; margin: 10px auto;"></select>
    <button onclick="prevStep(1)">上一步</button>
    <button onclick="captureIdPhoto()">拍照並進入下一步</button>
    <canvas id="idCanvas" width="320" height="240" style="display:none;"></canvas>
    <img id="idPreview" src="" style="display:none;">
  </div>

  <div id="step3" class="step">
    <h2>拍攝現場自拍照</h2>
    <video id="video" autoplay playsinline muted></video><br>
    <select id="cameraSelect2" style="display:block; margin: 10px auto;"></select>
    <button onclick="capturePhoto()">拍照</button><br><br>
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
    <img id="snapshot" src=""><br>
    <button onclick="prevStep(2)">上一步</button>
    <button onclick="nextStep(4)">下一步</button>
  </div>

  <div id="step4" class="step">
    <button onclick="prevStep(3)">上一步</button>
    <button onclick="submitPhotos()">開始驗證</button>
    <p id="result"></p>
    <pre id="ocrText"></pre>
    <pre id="ocrDetails" style="color: green;"></pre>
    <pre id="roomInfo" style="color: #856404;"></pre>
  </div>

<script>
const FACEPP_API_KEY = 'UwDnueoQfGQldxP6e_SJQpZUJtFAs9YA';
const FACEPP_API_SECRET = 'ks9e_h3BkVfQ52pvc-FyWgdzcHUvmY0S';
const FACEPP_ENDPOINT = 'https://api-us.faceplusplus.com/facepp/v3/compare';
const OCR_SPACE_ENDPOINT = 'https://api.ocr.space/parse/image';
const OCR_SPACE_API_KEY = 'helloworld';
const ID_WRITE_URL = 'https://script.google.com/macros/s/AKfycbzjPK4G4Kgj0X5lLRDeY2EixBAOFuw58uhMTc6G8WAZyHwOmXKUUo_qnpzBjPFLw-tu/exec';
const RESERVATION_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxcloKN6uq7sJ9-IrfMlecLdzDqrLSW-GXhVYl_m24i9nNv0t_oYsmwddelmsyLx8XkTg/exec';

function nextStep(n) {
  for (let i = 1; i <= 4; i++) document.getElementById('step' + i).classList.remove('active');
  document.getElementById('step' + n).classList.add('active');
  if (n === 2) initCameraSelector('cameraSelect', 'externalVideo');
  if (n === 3) initCameraSelector('cameraSelect2', 'video');
}
function prevStep(n) { nextStep(n); }

async function initCameraSelector(selectId, videoId) {
  try {
    await navigator.mediaDevices.getUserMedia({ video: true });
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(d => d.kind === 'videoinput');
    const select = document.getElementById(selectId);
    select.innerHTML = '';
    videoDevices.forEach(device => {
      const option = document.createElement('option');
      option.value = device.deviceId;
      option.textContent = device.label || `Camera ${select.length + 1}`;
      select.appendChild(option);
    });
    select.onchange = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: select.value } } });
      document.getElementById(videoId).srcObject = stream;
    };
    if (videoDevices.length > 0) {
      select.selectedIndex = videoDevices.length - 1;
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { deviceId: { exact: videoDevices[videoDevices.length - 1].deviceId } }
      });
      document.getElementById(videoId).srcObject = stream;
    }
  } catch (err) {
    alert("❌ 鏡頭初始化失敗：" + err.message);
    console.error(err);
  }
}

function captureIdPhoto() {
  const video = document.getElementById('externalVideo');
  const canvas = document.getElementById('idCanvas');
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataURL = canvas.toDataURL('image/jpeg', 0.9);
  document.getElementById('idPreview').src = dataURL;
  document.getElementById('idPreview').style.display = 'block';
}

function capturePhoto() {
  const ctx = document.getElementById('canvas').getContext('2d');
  ctx.drawImage(document.getElementById('video'), 0, 0, 320, 240);
  const dataURL = document.getElementById('canvas').toDataURL('image/jpeg', 0.9);
  document.getElementById('snapshot').src = dataURL;
}

async function submitPhotos() {
  const phone = document.getElementById('phone').value.trim();
  if (!phone) return alert('請輸入手機號碼');

  const idBlob = await (await fetch(document.getElementById('idCanvas').toDataURL('image/jpeg', 0.9))).blob();
  const selfieBlob = await (await fetch(document.getElementById('canvas').toDataURL('image/jpeg', 0.9))).blob();

  const reservationRes = await fetch(RESERVATION_SHEET_URL);
  const reservationData = await reservationRes.json();
  const matched = reservationData.find(e => e['電話'] === phone || e['電話'] === `'${phone}`);
  if (!matched) return document.getElementById('result').innerText = '❌ 查無預約';

  const formData = new FormData();
  formData.append('apikey', OCR_SPACE_API_KEY);
  formData.append('language', 'eng');
  formData.append('file', idBlob);
  const ocrRes = await fetch(OCR_SPACE_ENDPOINT, { method: 'POST', body: formData });
  const ocrData = await ocrRes.json();
  const text = ocrData?.ParsedResults?.[0]?.ParsedText || '';
  document.getElementById('ocrText').innerText = text;

  const idNumber = text.match(/[A-Z][12]\d{8}/)?.[0] || '';
  if (!idNumber) return document.getElementById('result').innerText = '❌ 身分證號未識別';

  const compareForm = new FormData();
  compareForm.append('api_key', FACEPP_API_KEY);
  compareForm.append('api_secret', FACEPP_API_SECRET);
  compareForm.append('image_file1', idBlob);
  compareForm.append('image_file2', selfieBlob);
  const compareRes = await fetch(FACEPP_ENDPOINT, { method: 'POST', body: compareForm });
  const compareData = await compareRes.json();

  const score = compareData?.confidence || 0;
  if (score < 60) return document.getElementById('result').innerText = `❌ 驗證失敗，相似度 ${score}`;
  document.getElementById('result').innerText = `✅ 相似度 ${score}`;

  const payload = new URLSearchParams();
  payload.append('data', [
    matched['商品名稱'],
    matched['姓名'],
    matched['電話'],
    matched['Email'],
    matched['開始時間'],
    matched['結束時間'],
    idNumber
  ].join(','));

  const writeRes = await fetch(ID_WRITE_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: payload
  });

  const writeText = await writeRes.text();
  document.getElementById('roomInfo').innerText = writeText.includes('Success') ? '✅ 身分證已寫入' : `❌ 寫入失敗：${writeText}`;
}
</script>
</body>
</html>
