<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è‡ªåŠ©å…¥ä½é©—è­‰</title>
  <style>
    .step { display: none; }
    .step.active { display: block; }
    video, canvas, img { width: 320px; display: block; margin: 10px auto; }
    pre { white-space: pre-wrap; background: #f3f3f3; padding: 8px; border-radius: 4px; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h2>è‡ªåŠ©å…¥ä½é©—è­‰æµç¨‹</h2>

  <div id="step1" class="step active">
    <label for="phone">æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</label>
    <input type="tel" id="phone" placeholder="è«‹è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼"><br><br>
    <button onclick="nextStep(2)">ä¸‹ä¸€æ­¥</button>
  </div>

  <div id="step2" class="step">
    <h2>æ‹æ”èº«åˆ†è­‰</h2>
    <video id="idVideo" autoplay playsinline muted></video><br>
    <button onclick="captureIdPhoto()">æ‹ç…§</button><br><br>
    <canvas id="idCanvas" width="320" height="240" style="display:none;"></canvas>
    <img id="idPreview" src="" style="display:none; border:1px solid #ccc;"><br>
    <button onclick="prevStep(1)">ä¸Šä¸€æ­¥</button>
    <button onclick="nextStep(3)">ä¸‹ä¸€æ­¥</button>
  </div>

  <div id="step3" class="step">
    <h2>æ‹æ”ç¾å ´è‡ªæ‹ç…§</h2>
    <video id="video" autoplay playsinline muted></video><br>
    <button onclick="capturePhoto()">æ‹ç…§</button><br><br>
    <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
    <img id="snapshot" src=""><br>
    <button onclick="prevStep(2)">ä¸Šä¸€æ­¥</button>
    <button onclick="nextStep(4)">ä¸‹ä¸€æ­¥</button>
  </div>

  <div id="step4" class="step">
    <button onclick="prevStep(3)">ä¸Šä¸€æ­¥</button>
    <button onclick="submitPhotos()">é–‹å§‹é©—è­‰</button>
    <p id="result"></p>
    <pre id="ocrText"></pre>
    <pre id="ocrDetails" style="color: green;"></pre>
    <pre id="roomInfo" style="color: #856404;"></pre>
  </div>

<script>
const FACEPP_API_KEY = 'UwDnueoQfGQldxP6e_SJQpZUJtFAs9YA';
const FACEPP_API_SECRET = 'ks9e_h3BkVfQ52pvc-FyWgdzcHUvmY0S';
const FACEPP_ENDPOINT = 'https://api-us.faceplusplus.com/facepp/v3/compare';
const OCR_SPACE_ENDPOINT = 'https://api.ocr.space/parse/image';
const OCR_SPACE_API_KEY = 'helloworld';
const ID_WRITE_URL = 'https://script.google.com/macros/s/AKfycbzjPK4G4Kgj0X5lLRDeY2EixBAOFuw58uhMTc6G8WAZyHwOmXKUUo_qnpzBjPFLw-tu/exec';
const RESERVATION_SHEET_URL = 'https://script.google.com/macros/s/AKfycbxcloKN6uq7sJ9-IrfMlecLdzDqrLSW-GXhVYl_m24i9nNv0t_oYsmwddelmsyLx8XkTg/exec';

function nextStep(n) {
  for (let i = 1; i <= 4; i++) document.getElementById('step' + i).classList.remove('active');
  document.getElementById('step' + n).classList.add('active');
  if (n === 2) initMainCamera('idVideo');
  if (n === 3) initFrontCamera('video');
}
function prevStep(n) { nextStep(n); }

async function initMainCamera(videoId) {
  try {
    await navigator.mediaDevices.getUserMedia({ video: true });
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(device => device.kind === 'videoinput');
    const backCamera = videoDevices.find(d => d.label.toLowerCase().includes('back') || d.label.toLowerCase().includes('rear')) || d.label.toLowerCase().includes('main')) || videoDevices[0];
    const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: backCamera.deviceId } } });
    document.getElementById(videoId).srcObject = stream;
  } catch (err) {
    alert("âŒ ç„¡æ³•å•Ÿç”¨ä¸»é¡é ­ï¼š" + err.message);
  }
}

async function initFrontCamera(videoId) {
  try {
    await navigator.mediaDevices.getUserMedia({ video: true });
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(device => device.kind === 'videoinput');
    const frontCamera = videoDevices.find(d => d.label.toLowerCase().includes('front')) || videoDevices[0];
    const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: frontCamera.deviceId } } });
    document.getElementById(videoId).srcObject = stream;
  } catch (err) {
    alert("âŒ ç„¡æ³•å•Ÿç”¨å‰é¡é ­ï¼š" + err.message);
  }
}

function captureIdPhoto() {
  const video = document.getElementById('idVideo');
  const canvas = document.getElementById('idCanvas');
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataURL = canvas.toDataURL('image/jpeg', 0.9);
  document.getElementById('idPreview').src = dataURL;
  document.getElementById('idPreview').style.display = 'block';
}

function capturePhoto() {
  const ctx = document.getElementById('canvas').getContext('2d');
  ctx.drawImage(document.getElementById('video'), 0, 0, 320, 240);
  const dataURL = document.getElementById('canvas').toDataURL('image/jpeg', 0.9);
  document.getElementById('snapshot').src = dataURL;
}

async function submitPhotos() {
  console.log("ğŸ‘‰ submitPhotos è¢«å‘¼å«äº†");

  const idCanvas = document.getElementById('idCanvas');
  const idDataUrl = idCanvas.toDataURL('image/jpeg', 0.9);
  const idBlob = await (await fetch(idDataUrl)).blob();

  const selfieDataUrl = document.getElementById('canvas').toDataURL('image/jpeg', 0.9);
  const selfieBlob = await (await fetch(selfieDataUrl)).blob();

  const phone = document.getElementById('phone').value.trim();
  if (!idBlob || !selfieBlob || !phone) {
    alert("è«‹å…ˆå®Œæˆæ‰€æœ‰æ‹ç…§èˆ‡è¼¸å…¥æ‰‹æ©Ÿè™Ÿç¢¼");
    return;
  }

  const reservation = await getReservationByPhone(phone);
  if (!reservation) {
    document.getElementById('result').innerText = "âŒ æŸ¥ç„¡é ç´„";
    return;
  }

  document.getElementById('result').innerText = "â³ é©—è­‰ä¸­...";
  const resizedId = await resizeImage(idBlob);
  const idNumber = await checkIfValidDocument(resizedId);
  if (!idNumber) {
    document.getElementById('result').innerText = "âŒ èº«åˆ†è­‰è­˜åˆ¥å¤±æ•—";
    return;
  }

  const formData = new FormData();
  formData.append('api_key', FACEPP_API_KEY);
  formData.append('api_secret', FACEPP_API_SECRET);
  formData.append('image_file1', resizedId);
  formData.append('image_file2', selfieBlob);

  try {
    const res = await fetch(FACEPP_ENDPOINT, { method: 'POST', body: formData });
    const json = await res.json();
    const similarity = json.confidence;

    if (similarity && similarity > 60) {
      document.getElementById('result').innerText = `âœ… ç›¸ä¼¼åº¦ ${similarity}`;
      const today = new Date().toISOString().split('T')[0];
      const usedRooms = JSON.parse(localStorage.getItem('usedRooms_' + today) || '[]');
      const room = [...Array(12).keys()].map(i => i + 1).find(r => !usedRooms.includes(r));
      if (!room) return document.getElementById('roomInfo').innerText = "âŒ æˆ¿é–“å·²æ»¿";
      usedRooms.push(room);
      localStorage.setItem('usedRooms_' + today, JSON.stringify(usedRooms));
      document.getElementById('roomInfo').innerText = `æˆ¿è™Ÿï¼š${room}
å…¥å ´å¯†ç¢¼ï¼š8899`;

      const payload = new URLSearchParams();
      payload.append('data', [
        reservation['å•†å“åç¨±'] || '',
        reservation['å§“å'] || '',
        reservation['é›»è©±'] || '',
        reservation['Email'] || '',
        reservation['é–‹å§‹æ™‚é–“'] || '',
        reservation['çµæŸæ™‚é–“'] || '',
        idNumber
      ].join(','));

      const writeRes = await fetch(ID_WRITE_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload
      });

      const writeText = await writeRes.text();
      document.getElementById('roomInfo').innerText += writeText.includes('Success')
        ? `
âœ… èº«åˆ†è­‰è™Ÿå·²å¯«å…¥`
        : `
âŒ å¯«å…¥å¤±æ•—ï¼š${writeText}`;
    } else {
      document.getElementById('result').innerText = `âŒ é©—è­‰å¤±æ•—ï¼Œç›¸ä¼¼åº¦ ${similarity}`;
    }
  } catch (e) {
    console.error(e);
    document.getElementById('result').innerText = "âš ï¸ é©—è­‰éç¨‹éŒ¯èª¤ï¼š" + e.message;
  }
}
</script>
</body>
</html>
